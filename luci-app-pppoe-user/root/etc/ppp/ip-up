#!/bin/sh
#
# This script is run by the pppd after the link is established.
# It should be used to add routes, set IP address, run the mailq
# etc.
#
# This script is called with the following arguments:
#    Arg  Name               Example
#    $1   Interface name     ppp0
#    $2   The tty            ttyS1
#    $3   The link speed     38400
#    $4   Local IP number    12.34.56.78
#    $5   Peer  IP number    12.34.56.99
#

#
# The  environment is cleared before executing this script
# so the path must be reset
#
PATH=/usr/sbin:/sbin:/usr/bin:/bin
export PATH

USERNAME=${PEERNAME}
IFACE=${1}
TTY=${2}
SPEED=${3}
LOCALIP=${4}
PEERIP=${5}

PPPOE_TIME="$(date "+%Y-%m-%d_%H:%M:%S")"
PPPOE_LOG="/home/log/pppoeuser"
PPPOE_LOG_FILE="${PPPOE_LOG}/$PEERNAME.log"
CONFIG="pppoe-user"
CONFIG_PATH="/var/etc/${CONFIG}"
SESSION_PATH="${CONFIG_PATH}/session"

CFGID="$(uci show $CONFIG | grep "$PEERNAME" | cut -d '.' -sf 2)"
USER_PACKAGE="$(uci get $CONFIG."$CFGID".package)"
USER_REGISTER="$(uci get $CONFIG."$CFGID".register)"
USER_QOS="$(uci get $CONFIG."$CFGID".qos)"
USER_DOWNLOAD="$(uci get $CONFIG."$CFGID".download)"
USER_UPLOAD="$(uci get $CONFIG."$CFGID".upload)"
USER_CONNECT="$(uci get $CONFIG."$CFGID".connect)"
RENEWAL_DATE="$(uci get $CONFIG."$CFGID".expires)"

SQM_ENABLED="$USER_QOS"
SQM_INTERFACE="$IFACE"
SQM_DOWNLOAD="$USER_UPLOAD"
SQM_UPLOAD="$USER_DOWNLOAD"
SQM_QDISC="$(uci get $CONFIG."$CFGID".qdisc)"
SQM_SCRIPT="$(uci get $CONFIG."$CFGID".script)"
SQM_LINKLAYER="$(uci get $CONFIG."$CFGID".linklayer)"
SQM_DEBUG_LOGGING="$(uci get $CONFIG."$CFGID".debug_logging)"
SQM_VERBOSITY="$(uci get $CONFIG."$CFGID".verbosity)"
SQM_OVERHEAD="$(uci get $CONFIG."$CFGID".overhead)"

PID="$(cat /var/run/"$IFNAME".pid 2>/dev/null)"
#MAC="$(top -bn1 | grep pppoe-server | grep "${PID}" | awk '{print $13}' | cut -d : -f 2,2-7)"
#MAC="$(top -bn1 | grep pppoe-server | grep "${IPREMOTE}" | awk '{print $13}' | cut -d : -f 2,2-7)"
#MAC="$(ps -w | grep pppd | grep -h -m 1 "${PID}" | awk '{print $10}' | cut -d : -f 2,2-7)"
MAC="$(ps -w | grep pppd | grep -v 'grep'| grep -h -m 1 "${PID}" | awk '{print $10}' | cut -d : -f 2,2-7)"

mkdir -p ${PPPOE_LOG}
mkdir -p ${SESSION_PATH}

echo "$PPPOE_TIME $PEERNAME Online $IFNAME $PID $DEVICE $IPREMOTE $MAC" >> /home/log/userup.log

echo "$PPPOE_TIME $PEERNAME Online interface: $IFNAME pid: $PID device: $DEVICE clientIP: $IPREMOTE clientMAC: $MAC" >> "$PPPOE_LOG_FILE"
echo >> "$PPPOE_LOG_FILE"

cat <<-EOF > ${SESSION_PATH}/"$USERNAME"."$IFACE"
	{
	    "username": "${USERNAME}",
	    "mac": "${MAC}",
	    "pid": "${PID}",
	    "interface": "${IFACE}",
	    "tty": "${TTY}",
	    "speed": "${SPEED}",
	    "ip": "${PEERIP}",
	    "package": "${USER_PACKAGE}",
	    "register": "${USER_REGISTER}",
	    "uptime": "${PPPOE_TIME}",
	    "updated": "${RENEWAL_DATE}"
	}
EOF

uci set $CONFIG."$CFGID".macaddress="$MAC"
uci commit $CONFIG
"
iptables -w -t mangle -A pppoe_user -s "$PEERIP" -m connlimit --connlimit-above "$USER_CONNECT" -j DROP

uci set sqm."$USERNAME"=queue
uci set sqm."$USERNAME".enabled="$SQM_ENABLED"
uci set sqm."$USERNAME".interface="$SQM_INTERFACE"
uci set sqm."$USERNAME".download="$SQM_DOWNLOAD"
uci set sqm."$USERNAME".upload="$SQM_UPLOAD"
uci set sqm."$USERNAME".qdisc="$SQM_QDISC"
uci set sqm."$USERNAME".script="$SQM_SCRIPT"
uci set sqm."$USERNAME".linklayer="$SQM_LINKLAYER"
uci set sqm."$USERNAME".overhead="$SQM_OVERHEAD"
uci set sqm."$USERNAME".debug_logging="$SQM_DEBUG_LOGGING"
uci set sqm."$USERNAME".verbosity="$SQM_VERBOSITY"
uci commit sqm
/usr/lib/sqm/run.sh start "$IFACE"

SQM_STARTING="$(tc -s qdisc show dev "$IFACE" | grep qdisc)"
echo "$PPPOE_TIME $USERNAME Connections: $USER_CONNECT Starting QOS: $SQM_STARTING" >> /home/log/pppqos.log

exit 0
